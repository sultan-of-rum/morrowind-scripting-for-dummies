% Chapter sectioning
\hypertarget{tips-and-tricks}{%
\section{\texorpdfstring{\hfill\break
Tips and tricks}{ Tips and tricks}}\label{tips-and-tricks}}

\hypertarget{little-helpers-text-search-copy-paste}{%
\subsection{Little helpers: Text search, copy,
paste}\label{little-helpers-text-search-copy-paste}}

A good function to use for the beginning scripter is the search text
function in the main TESCS edit menu. You can use it to search scripts,
e.g. for a specific function you would like to use and want to find
sample scripts for.

You can also use any text-editor, or the alternative scripting editors
listed below for editing your scripts and copy / paste the script to and
from the TES CS editor using ctrl-c / ctrl-v.

To make a copy of a script you want to change, don't just change the
name, this will just overwrite the old script. Instead copy the original
script (ctrl-a, ctrl-c) start a new script and paste the old one in
(ctrl-v) now rename the script and change what you need.

\hypertarget{alternative-scripting-editors}{%
\subsection{Alternative scripting
editors}\label{alternative-scripting-editors}}

1) MentalElf created an Elder Scrolls Scripting mode for the venerable
\textbf{EMACS} coding editor, including automatic tabulation of
if-blocks, and color coding of script code.:

%\url{http://www.mentalelfz.com/}

EMACS is available for free under the gnu license (link is on MetalElf's
page).

2) UESP's Dave Humphrey created \textbf{MWEdit,} an alternative
construction set with improved scripting support (This is a beta
version. I have only tested it briefly, but it looks very good, and
seemed quite stable): %\url{http://mwedit.sourceforge.net/}

Regarding scripting, Dave lists the following features:

- Color coding of script code. Use a default white or blue color scheme
or use any custom colors to identify the various word types. Can also be
disabled. (\emph{see the trigonometry script below for an example of the
color coding})

- Select the font used in the script window.

- New script compiler reports many more errors and possible errors.

- Three levels of warning/error messages (weak, default, and strong)
allowing you to set how many compiler messages are recorded.

- Compiler adds spaces to the script output where they might be required
or expected (such as in if statements).

- Object types used in functions are checked more rigorously. If the
function expects an NPC ID, you'll receive an error/warning if you use
another type.

- Compiles script on save automatically (no warning/errors displayed).

- Export and import scripts to/from text files.

- View detailed help on all script functions.

- All compiler errors/warnings are displayed in a splitter pane at the
bottom of the script window. Double-click a message to jump to the
location of the message.

- View detailed information on compiler messages and display the
function help if the message is related to a specific function.

- Compiler does not permit the use of reserved words as local variables
(such as end, X, Y, etc...).

- Functions that are known to be broken will result in a compiler
message.

- Simple function tooltips can be displayed for faster scripting.

\hypertarget{script-extenders}{%
\subsection{Script Extenders}\label{script-extenders}}

Script extenders are programs that need to be run at the same time as
Morrowind to work, they add new functions to the Morrowind scripting
language.\\
This is by no means a guide to 3\textsuperscript{rd} party programs; it
is intended to give a brief overview. To find out more, it is
recommended that you download the programs/dev kits.

A list of mods made using script extenders that should give an overview
of what is possible:\\
http://www.mwmythicmods.com/MWE.htm

Morrowind Enhanced (MWE):

%\url{http://planetelderscrolls.gamespy.com/View.php?view=Utilities.Detail\&id=8}\strut \\
Adds many new functions, including getting references and using them
with the vanilla Morrowind functions. It also adds better sound
detection, skill leveling functions and functions to manipulate spells.

Scripts are written in the TESCS, with functions using unused commands
like ToggleLoadFade. The esp then has to be processed by another
compiler.\\
Unfortunately it is no longer being developed.

Morrowind Script Extender (MWSE):\\
%\url{http://sourceforge.net/projects/mwse/}

MWSE is fairly similar to MWE in some respects, as it can get
references, and then use those references with other default functions.
It adds more functions than MWE, and is still being developed. It is
slightly harder to code with, in that the MWSE functions cannot be used
within normal if blocks, only within new ifx blocks, which have some
drawbacks. However, the script readability is improved as it uses words
for functions rather than cryptic unused commands and variable settings.

To compile MWSE scripts, you need to use MWEdit\textbf{.}

Morrowind Graphics Extender (MGE):

%\url{http://www.tesnexus.com/downloads/file.php?id=5535}\strut \\
MGE mainly allows manipulation of the rendering to the screen, so if you
want to draw a texture to the screen, it is the program you want. It
also allows you to apply shaders to the screen, press keys, manipulate
the mouse, use bumpmaps and other graphics related features.

It requires MWSE (Included in MGE), and scripts are compiled using
MWEdit

\hypertarget{script-with-style-for-safer-scripting}{%
\subsection{Script with style for safer
scripting}\label{script-with-style-for-safer-scripting}}

This is bound to be a bit controversial as it is as much about personal
style as it is about fact. And it's bound to sound snobbish .
Nevertheless, I think this might be of some use for the newcomer, so
here are a few comments about my personal views on good style and safer
scripting:

\begin{itemize}
\item
  Use annotations. In a really short script they might seem useless, but
  even there you might want to state which mod/quest/item they belong to
  or what their general purpose is, etc. For long scripts this becomes
  indispensable, for yourself, if you stop working for a few days as
  well as for others that might want to learn from your script. Explain
  your variables, put headers on the main part of your script, comment
  on important lines of code, etc.
\item
  Use state variables with style. Basically, due to the "executed once a
  frame" nature of the scripts this is your principal way of structuring
  your script for sequential events. There are several things to this.\\
  A) Limit yourself to the minimal amount you need for the script.\\
  B) use elseifs to chain different states of one state variable
  together, not separate if-blocks -- this should be the main structural
  element of your script (it's not always possible nor necessary, but if
  it is, its going to save you a lot of trouble).\\
  C) Check the elseifs are arranged from lowest to highest and in a
  logical order of events -- will help you to keep everything organized,
  and thus avoids bugs. Jumping around wildly with state variables is
  the equivalent to careless use of GOTO in good old BASIC.\\
  D) Use them extensively, do small steps. I can't tell you how many
  times bugged scripts started working simply because I moved some
  functions to a separate "state-block". Sometimes this doesn't seem to
  be logical at all -- but if you can safely enter another step, do it.
\item
  Decide for one style. TES Script is relatively forgiving regarding
  syntax. You can write functions small letters or capitalized as in
  this document, or all caps. You can use if ( SomeFunction == 1 ) of if
  (somefunction). But whatever you choose, try to be consistent in your
  usage.
\item
  Use verbose variable names. A name that reflects the function of this
  variable makes a script much more readable. If you use global
  variables give them a unique name, e.g. put your initials in front or
  whatever -- just try to minimize the chance that another mod will come
  up with the same name for a global -- because that would screw things
  up royally.
\item
  Keep track of your Return function uses. The Return function is
  inherently dangerous -- remember that it will stop anything in that
  script below that line from being executed. Use it, but use it
  sparingly. If you have the feeling you have to use it a lot in one
  script, you should probably introduce a state variable instead.
\end{itemize}

\hypertarget{cleaning-up-your-mod}{%
\subsection{\texorpdfstring{\hfill\break
Cleaning up your
mod}{ Cleaning up your mod}}\label{cleaning-up-your-mod}}

When you work on your mod, you will probably want to look up other
things as reference or simply to cut and copy things for your own
purposes. The problem is that the TESCS will remember you looked at the
things if you moved them the slightest bit in the game world, or if you
ever hit an ``OK'' button, even if you did not change anything. Before
you release your mod you should check it for such unwanted references
and remove them.

In the File Menu select Data Files. Then select your mod like you
normally would and hit the Details button. Look at the list of features
here: this is a list of everything your mod changed or added. Look for
things that you did not want to change, and select them.

Select a single item with Left Click.

You can select multiple items using Ctrl + Left Mouse Button.

If you click on an item and then use Shift + Left Click on another item,
everything in between will be selected.

You don't have to select everything you want to remove at once, you can
do it in multiple deletes.

To remove items, hit {[}del{]} on your keyboard. This marks the feature
as ignored. Loading and resaving the mod will remove these ignored
features from the mod.

An alternative, and much easier to use is the utility TESAME (TES
advanced mod editor), available from various sites, e.g.:

%\url{http://theseventhrealm.com/portal/tools.html}

A more recent tool that has become indispensable to me is the Morrowind
Enchanted Editor, available at:

%\url{http://tfo.rh.rit.edu/esforum/secretmasters/EnchantedSetup0.91c.exe}.

It's not very well documented, but offers a much nicer user interface
than TESAME and is immensely powerful.

For scripts, try to remove any unused global variables or whole scripts
you may have made in the course of developing your script. It bloats
your .esp filesize, it probably wastes memory, or at the very least it
looks bad.

This is a list of the change indicators found in the details tab of
TESAME:

DIAL -- A new or changed topic

INFO -- A dialogue response, or journal entry

REFR -- a reference of an object that was put into the game world, while
MISC, CONT etc. describe the actual Object (even if there is no instance
of it placed in the world)

SOUN -- A Sound

NPC\_ - A new type of NPC, or a changed NPC

CREA -- A new creature or a change to a creature

LIGH -- A new or changed Light

LTEX -- An application of a landscape texture

PGRD -- A change to the AI grid

CELL -- obvious, signifies a changed cell either indoors or outdoors --
in case your mod had nothing to do with that cell you should get rid of
it. This affects all changes in that cell automatically, I think
automatically

SCRPT -- A Script -- lots of people leave superfluous "test scripts" in
their mods -- that's bad style, I think.

MISC -- A new or changed miscellaneous object -- check names, delete if
the change is unrelated to your plugin

ACTI -- An activator -- see above

CONT -- A container -- very critical: make sure you only change a new ID
(copy of a container), not the original container -- or they will all be
changed.

STAT -- A static object -- see above

\hypertarget{on-references-persist}{%
\subsection{\texorpdfstring{\hfill\break
On References
Persist}{ On References Persist}}\label{on-references-persist}}

The object windows in the TESCS have a checkbox named "References
persist". Ticking this checkbox ensures that a reference (an instance of
the object in the game world) is always available to be referenced by
script, even if the player is in a different cell, or has not yet
encountered the object.

If a script uses a specific reference to an object such as

RefObject-> Enable

Then "RefObject" should have References persist checked.

Indirect referencing such as;\\
PlaceAtMe my\_object 1 1 1\\
Player-> AddItem my\_object 1

do not usually require references persist. Some functions may be
exceptional in this respect. For example;

GetDistance, RefObject

requires that RefObject has been placed in the world and references
persist checked.

Actors (NPC and Creatures) are always persistent.

(Thanks to Nigedo for additional information)

\hypertarget{the-72-hours-bug-a-brief-explanation}{%
\subsection{The "72-Hours Bug": A Brief
Explanation}\label{the-72-hours-bug-a-brief-explanation}}

(Thanks to DinkumThinkum, Emma, Iudas, Qarl and others for this
information.)

The so-called "72-Hours Bug" is not really a bug at all - nor is it
necessarily 72 game hours. The time is set by fCorpseClearDelay (see
"Game Settings"), which defaults to 72, and which also controls the
delay before non-persistent corpses vanish. After the specified time,
some temporary data is cleared to improve game performance.

Examples include:

\begin{itemize}
\item
  Talked to PC flag (dialogue) is reset.
\item
  ForceGreeting: an actor will not be available for a ForceGreeting
  after the specified time unless "Corpses persist" is checked in the
  object info box.
\item
  Actor stats and skills are reset to editor/autocalc levels.
\item
  AI resets: e.g. an actor in combat with the player but with a low
  fight setting will no longer attack.
\item
  Targeted scripts on non-persistent objects lose their targeting.
\item
  OnActivate may be reset (see function description for more details).
\end{itemize}

Specific workarounds are mentioned in the relevant function's
description. Alternatively, other methods can be used to store
information. For example:

\begin{itemize}
\item
  A script that runs at least once each load session can be used to keep
  track of information, e.g. a companion's stats and skills.
\item
  Journal entries or global variables can be used to store information,
  e.g. as a substitute for the Talked to PC flag.
\item
  Token items may be added to an actor's inventory (or a refs persist
  container).
\end{itemize}

Of course, other workarounds may be devised. Note that it is usually not
advisable to change the value of fCorpseClearDelay, as GMSTs are not
accessible to script and your change may break mods which rely on
time-dependent methods of avoiding the loss of temporary data. (Changing
the setting to a \emph{higher} value is less likely to break other mods,
but more likely to cause CTDs for those whose system can't cope with the
amount of data stored.)

\hypertarget{limits-of-the-script-editor}{%
\subsection{Limits of the Script
Editor}\label{limits-of-the-script-editor}}

\textbf{Character Limit:} There is a limit of the maximum number of
characters per script. It is somewhere around 30000 characters ( the
true limit is most likely 32767, which is the max value for a 16-bit
signed integer, which is how script length is stored in the .esp --
thanks to Horatio for this info). If this occurs you can no longer type
in the editor window. To save characters try the following:

\begin{itemize}
\item
  Remove characters
\end{itemize}

\begin{itemize}
\item
  Use shorter variable names
\item
  See if the script can be split and some part maybe handled in a global
  script or attached to a separate object as a separate script.
\end{itemize}

\textbf{Line Limit:} there also is reportedly a maximum line limit. This
seems to vary and reports on the forum range between 900-and 1500 lines
of code. It's probably rather a limit of the compiled script than the
actual lines of text, so empty lines and comments don't count. This is
reported by an error message upon saving the script.

\textbf{If-elseif limit:} There is a limit on the maximum number of
if-elseif conditions that can be used per script. I am not sure of the
absolute number (I heard both 127 and 256). Also there is a maximum
depth of nested if commands, it's reportedly 10 (thanks Riiak).
\emph{(Note: Error message for exceeding the maximum depth of nested
if's is "Max nesting of 10 exceeded on line XXX" - in this case, you'll
need to break it up somehow.)}

\textbf{Instruction Limit:} An If-block or While-block is limited to 255
compiled commands (per block, not per script). The limit is \emph{not}
on the number of lines (each line may end up as several commands when
compiled), and blank lines and comments don't count towards this total.
-(Dave Humphrey, thanks to Galsiah for pointing this out)

\hypertarget{script-name-limit-tunaandcheese-reported-a-limit-to-the-length-of-the-scriptname-your-scripts-name-should-never-go-over-31-characters-in-length.-it-if-you-have-32-characters-in-the-script-name-there-will-be-a-box-on-the-end-of-the-script-and-when-there-is-33-characters-the-33rd-character-goes-funny-the-34th-character-seemed-to-be-fine.}{%
\paragraph{\texorpdfstring{\textbf{Script Name Limit:} TunaandCheese
reported a limit to the length of the scriptname:\\
Your script's name should never go over 31 characters in length. It if
you have 32 characters in the script name there will be a box on the end
of the script and when there is 33 characters the 33rd character goes
funny, the 34th character seemed to be
fine.}{Script Name Limit: TunaandCheese reported a limit to the length of the scriptname: Your script's name should never go over 31 characters in length. It if you have 32 characters in the script name there will be a box on the end of the script and when there is 33 characters the 33rd character goes funny, the 34th character seemed to be fine.}}\label{script-name-limit-tunaandcheese-reported-a-limit-to-the-length-of-the-scriptname-your-scripts-name-should-never-go-over-31-characters-in-length.-it-if-you-have-32-characters-in-the-script-name-there-will-be-a-box-on-the-end-of-the-script-and-when-there-is-33-characters-the-33rd-character-goes-funny-the-34th-character-seemed-to-be-fine.}}

Character 32 gets replaced by some other character in the title bar and
in the Details list information. From looking at the .esm/.esp/.ess
format information on Argent's web site, apparently only 32 bytes are
allocated for the script name, which makes a 31 character limit
reasonable. -(DinkumThinkum)

\hypertarget{pitfalls}{%
\subsection{Pitfalls}\label{pitfalls}}

\hypertarget{inconsistent-commas}{%
\subparagraph{Inconsistent Commas}\label{inconsistent-commas}}

The scripting language is fairly forgiving in terms of comma usage or
not, but the inconsistent use of commas can cause difficulties:

This will work:

Player-> PositionCell, -1396, 124, 3312, 90, "Cell ID"

and this will work:

Player-> PositionCell -1396 124 3312 90 "Cell ID"

but this will sometimes have problems:

Player-> PositionCell -1396, 124, 3312, 90 "Cell ID"

\hypertarget{object-names}{%
\subparagraph{Object Names}\label{object-names}}

Don't start object names with an underscore. Otherwise, some script
operations will fail.

This will cause runtime error.

\_wr\_testNPC-> forceGreeting

This will work fine

wr\_testNPC-> forceGreeting~;-\/-Okay.

\hypertarget{fractional-numbers}{%
\subparagraph{Fractional Numbers}\label{fractional-numbers}}

A constant float specified without digit before the decimal point will
cause a runtime error. Floats in the range: -1 < 0 <
1 should be specified with a leading '0'. Otherwise you'll experience a
runtime error.

This gives you a runtime error

if ( number == .2 )~

This runs fine

if ( number == 0.2 )

34th Variable

If you have a script with 34 or more variables of the same type (short,
long or float), the 34th variable of that type can cause errors when
used. For that reason, most scripters call it "DoNotUse" or something
like that to remember that they should not use it. The reason for this
problem seems to be that the ASCII character 34 is the double quote
character.

Short 32ndVar

Short 33ndVar

Short DoNotUse ;Really the 34\textsuperscript{th} Var

Short 34thVar

Short 35thVar

\hypertarget{saving-cpu-time}{%
\subsection{\texorpdfstring{\hfill\break
Saving CPU time}{ Saving CPU time}}\label{saving-cpu-time}}

If you plan a mod with lots of scripts or long and involved scripts, you
may want to give some thought to not wasting CPU power. There are a
number of things you can do here:

If the script does not have to be executed every frame, \textbf{put a
little counter in there}:

\lstinputlisting{scripts/My_super_long_script.txt}

This little piece of code, that should be at the very top of your
script, will allow your script (or rather the main, CPU power eating
part of it) to be executed only every 10\textsuperscript{th} frame. You
could do the same thing with a timer, and execute the script only every
3 seconds or once every minute.

\textbf{Execute script only if the player is suitably near.} If you have
scripted a fancy magic bouncing ball, or basically anything that is a
visible effect, there is no reason to run the script if the player
cannot see it. So put something like this on top of your script:

If ( GetDistance, player < 5000 )

Return

Endif

However, as getDistance isn't an amazingly fast function, you wouldn't
want to put this check above a simple getScale, setScale script.

\textbf{Shortcut scripts that are no longer needed.} If you have local
scripts that you may not need from a certain point onwards, e.g. because
of Actor death or because the object was disabled, reduce their CPU need
by putting something like the following at the top of the script:

if ( GetDisabled == 1 )

Return

Endif

If ( GetHealth <= 0 )

Return

Endif

\textbf{Terminate global scripts.} Remember, global scripts are running
all the time until you stop them again with StopScript. You can do
do-once global scripts by just putting a StopScript command at their end

\lstinputlisting{scripts/do_once_global_script.txt}

\textbf{Try to use local scripts} instead of global scripts. With local
scripts you are sure that they only run when you are in the vicinity.
Think hard before making a script global if it can be done with a local
script instead.

\textbf{Be careful with while-loops, GetDetected, GetLOS} and other
"slow" functions. Use methods as described above (e.g. a counter or a
timer) to make sure they are not called too often.

\textbf{Stop script while in menu mode.} Always, unless you have
specific reason not to, put the following at the top, to avoid the mouse
lagging in the menu and other unwanted effects.

If ( MenuMode == 1 )

Return

Endif

%\hypertarget{section-12}{%
%\subsection{}\label{section-12}}

\textbf{In general, reducing the number of scripts running improves
efficiency} more than reducing the complexity of individual scripts.

So, for example, if you have two short globals running all the time, it
is better to merge them into one global.

If you've got a few global scripts which only need to run based on some
check, it makes sense to place the checks in one "parent" script, and
startscript the others from there when they need to run (remembering to
ensure to run them once per game session if they need to conserve
variable values).

\hypertarget{targeted-scripts-running-global-scripts-tied-to-an-object}{%
\subsection{\texorpdfstring{\hfill\break
Targeted scripts: running "global" scripts tied to an
object}{ Targeted scripts: running "global" scripts tied to an object}}\label{targeted-scripts-running-global-scripts-tied-to-an-object}}

"Object\_ID"-> StartScript "Script\_ ID"

\emph{(Credit for discovery of this technique and much of the following
information goes to FreshFish. Further information supplied by Riiak,
MentalElf, DinkumThinkum, Argent, Cortex, and others.)}

It is possible to use the StartScript function to run global scripts
that are tied to an object or Actor. These scripts resemble both local
scripts (in that the functions called always default to the object or
Actor the script targets) and global scripts (in that they are always
running). Objects may have several different targeted scripts running on
them at one time, and may also have a local script.

\hypertarget{to-start-a-script-as-a-targeted-script}{%
\subparagraph{To start a script as a targeted
script:}\label{to-start-a-script-as-a-targeted-script}}

\begin{itemize}
\item
  Object\_ID-> StartScript Script\_ID (may be used from
  script, but does not work from dialogue results).
\item
  Start the script from the intended target's local script or another
  targeted script on the object (it will inherit the target).
\item
  Start the script from dialogue results (this will only work to target
  the actor the player is in dialogue with: it is not possible to
  specify a different target in dialogue results). This method is
  particularly useful as you don't need access to scripts running on the
  actor, nor do you need an ID.
\end{itemize}

\hypertarget{uses-of-targeted-scripts}{%
\subparagraph{Uses of targeted
scripts:}\label{uses-of-targeted-scripts}}

As a general rule: If a function requires a fix in a global script but
the fix can be omitted in a local script, that function may be used
without a fix in a targeted script as well. Examples of popular
functions for targeted scripts include:

AddItem, RemoveItem, GetItemCount

AIFollow, AIWander, AIEscort

GetPos, SetPos, PositionCell

Get/Set/Mod\emph{Stat}

StartCombat, StopCombat

Targeted scripts can be powerful tools, especially in combination with
dialogue: you can create generic dialogue (e.g. filtered for class only)
and start your script from the resultbox. CDCooley's "Companion
Teleportation" is a good example of use with dialogue. Voice dialogue
can also be used this way: for example, many companions have a targeted
"pacifist" script that is started from Attack voice results if the
player tells the companion to avoid combat.

\hypertarget{cautions-and-limitations}{%
\subparagraph{Cautions and
limitations:}\label{cautions-and-limitations}}

\begin{itemize}
\item
  Variables defined in a targeted script are not considered local to the
  object from the point of view of dialogue and other scripts. For
  example, they cannot be used as dialogue conditions. The special
  variable "companion" also cannot be used, i.e. declaring a short
  variable "companion" in a targeted script and setting it to 1 will not
  enable companion share on the target actor. I assume this applies to
  other special locals as well, but I haven't tested any others.
\item
  You cannot have more than one instance of a targeted script running at
  one time (same as global scripts). The obvious workaround is to have
  several different scripts that all do the same thing.
\item
  If OnActivate is used in a targeted script, the object will not be
  able to be activated by normal means after the script is stopped,
  unless a targeted script with an OnActivate is again added to the
  object.
\item
  If an object is deleted while a targeted script is running on it, the
  game will CTD. If the target is not necessary but is merely a
  consequence of the way the script was started, you can usually target
  the script on the player instead to avoid this:
  "player-> StartScript ScriptName". Otherwise, the script
  must be stopped before deleting the object.
\item
  Scripts will detach from non-persistent targets when the game is saved
  and reloaded. This may give errors on load ("Unable to locate
  reference for global script\ldots"), or may not; either way it may
  also give odd effects in some circumstances.
\item
  When a targeted script is started on an object that was not placed
  into the gameworld in the editor (i.e. an object that was placed or
  generated during the game), the script will lose its targeting when a
  savegame is reloaded. Note that this applies to the player character
  as well.
\item
  Load list changes may also cause targeted scripts to lose their
  targeting when the game is reloaded, whether or not the target is
  persistent and whether or not it was placed in the editor. This
  doesn't always happen, but it can (adding several mods higher in the
  load list will usually do it).
\end{itemize}

If a script becomes detached from its target, some functions that
manipulate data about the previously targeted object (e.g.
getHealthGetRatio) may cause CTD if used without a fix.

As a workaround to avoid untargeted scripts running, you may be able to
use a startscript to stop the targeted script if it is running, then
restart it if necessary. As a safety check for targeted scripts on
actors, GetHealth may be used before any functions that may cause
problems (returns 0 in an untargeted script):

if ( GetHealth <= 0 )

StopScript ScriptName

return

endif

; main body of script goes here

\hypertarget{detecting-when-the-player-does-a-load-from-saved-game}{%
\subsection{Detecting when the player does a load from saved
game:}\label{detecting-when-the-player-does-a-load-from-saved-game}}

Some reasons to test for player loading a saved game:

1) To continue custom music (mp3 type music resets on load).

2) To keep a NPC running or sneaking.

3) To reset an object to its proper scale (if outside of range 0.5 to
2.0).

There are a number of ways to do this:

JOG proposed the use of SetJournalIndex:

if ( ( getjournalindex "dummy" ) != 100 )

Messagebox "You just reloaded, Cheater!!!"

setjournalindex "dummy" 100

endif

"Dummy" is any journal-topic that has no text for index 100.

Setjournalindex will set the index to the new value, no matter if an
entry exists for this value or not, but when you reload, the index will
be reset (see SetJournalIndex for more information).

MentalElf suggested that GetForceRun, GetForceSneak, GetScale can all be
used to detect when the player has just loaded a save game. This is due
to ForceRun and ForceSneak being cleared during a load from saved game,
and scale is set to within the range 0.5 to 2.0. In my opinion ForceRun
is best, as ForceSneak puts the NPC into a crouch posture.

; (NPC object)

if ( GetForceRun == 0 )

; Player just loaded a saved game

; Handle game load here.

ForceRun

Endif

A different option is to use start scripts ( available only with
Tribunal and Bloodmoon): Here are two examples by Dinkum Thinkum:

\lstinputlisting{scripts/DT_DoOnce_TribStartScript02.txt}

\lstinputlisting{scripts/DT_DoOnce_TribStartScript01.txt}

\hypertarget{uses-of-the-chargenstate-variable---disabling-saving-and-menus}{%
\subsection{Uses of the CharGenState variable - Disabling saving and
menus}\label{uses-of-the-chargenstate-variable---disabling-saving-and-menus}}

The availability of the save option in the main menu (and the Quicksave
key) depends on the value of the CharGenState global. Set it to
something other than -1 (to 99, for example), and the player is no
longer allowed to save the game. Setting CharGenState back to -1 again
turns everything back to normal.

This has several side effects. First, you won't be able to access the
menu screen. This can be fixed by EnableStatsMenu - it reenables ALL the
menus, not only the stats window. However, the journal, the Quick Keys
and the QuickKey menu (F1) are disabled as well, and you can't loot
corpses. I haven't found a way around these limitations.

There is some conflict potential in this, so it would be good to take
some precautions that the player is not currently inside the character
generation sequence, and that the value is set back to its original
value after use.

(Forum info / Erstam)

\textbf{Note:\\
}If you use a command like EnableStatsMenu or EnableInventoryMenu while
CharGenState is other than -1, you will never be able to turn off the
menus again with CharGenState. The EnableInventoryMenu command only
seems to have this effect in the CharGen process, while EnableStatsMenu
has this effect all the time. If the menus were supposed to be turned
off in a mod, it won't work. You still can't save or use quick keys. But
what really is annoying about this is that this applies for the whole
game session! You actually need to exit the game and restart it, so you
can never rely on that menus will be turned off.

(Forum info / Björn )

\hypertarget{detecting-use-of-scrolls-or-books}{%
\subsection{\texorpdfstring{\hfill\break
Detecting use of scrolls or
books}{ Detecting use of scrolls or books}}\label{detecting-use-of-scrolls-or-books}}

This is a surprisingly difficult task, as OnActivate and OnPCEquip are
both needed AND don't work quite as expected. Kir has found a solution
as shown in this script for invoking a letter of credit:

\lstinputlisting{scripts/BankLetter10.txt}

Erstam posted a script with even better features, that also revealed an
interesting glitch with the scripting variables OnPCEquip / SkipEquip:

"Inspired by the BankLetter script in MSFD 7, I have found a way to run
custom script code on books and scrolls when either "equipped" from the
player's inventory or activated from the game world, \emph{while the
book/scroll is displayed as normally}. Surprisingly, it's the
PCSkipEquip variable that is set to 1 when the book is dropped on the
player's portrait, rather than the OnPCEquip variable. This is the code
I used:"

\lstinputlisting{scripts/activateBook.txt}

It should work without the doOnce condition, in case you want the action
to take place every time you equip the book, but I haven't tested it
yet.

\hypertarget{making-actors-switch-between-weapons}{%
\subsection{\texorpdfstring{\hfill\break
Making Actors switch between
weapons}{ Making Actors switch between weapons}}\label{making-actors-switch-between-weapons}}

Since the equip function does not work, the only way to do this is to
take items away from the Actor, or to modify his skills at runtime.

Here is an example I used to make a guard switch between bow and sword:

\lstinputlisting{scripts/HBCaravanGuardAI.txt}

The next example is one by Bethesda, which does the same thing, using
the skill change method (admittedly more elegant than mine ):

\lstinputlisting{scripts/marksmanToggle.txt}

\hypertarget{making-npcs-switch-between-spell-sets}{%
\subsection{Making NPCs switch between spell
"sets"}\label{making-npcs-switch-between-spell-sets}}

If you want an NPC to switch between different sets of spells, the
skill-setting method will not work unless the spells are grouped into
different schools (which is unlikely to be the case). Adding and
removing spells will only take effect when the NPC is not in combat, but
StopCombat will stop combat for all actors involved (usually not a good
idea). However, other AI commands can be used to stop combat for a
single character. This method is more useful for followers of the player
than for hostile NPCs as the character will exit combat, however
briefly: since the enemy will generally attack the player rather than a
follower, temporarily removing a follower from combat is unlikely to
cause problems; using AIFollow to remove the follower from combat
ensures that the NPC will immediately re-enter combat at the first hit
by or on the player. AIWander (and probably other AI commands) will also
work, but you may need to restart combat using StartCombat afterwards.

The following example is an abbreviated snippet from the local script of
a companion I'm working on. Most of the time the spell-switching is
barely noticeable (just a moment of hesitation), and the companion
quickly re-enters combat.

\begin{lstlisting}
	;CombatStyle is set from dialogue when the player gives combat orders
	
	if ( CombatStyle == 1 ) ;switch between targeted and touch spells
	
	if ( player-> GetSpellReadied == 1 )
	
	set CombatMage to 1
	
	elseif ( player-> GetWeaponType >= 9 )
	
	set CombatMage to 1
	
	elseif ( player-> GetWeaponType <= 8 )
	
	set CombatMage to 2
	
	endif
	
	elseif ( CombatStyle == 2 ) ;switch between targeted spells and weapons
	
	if ( player-> GetSpellReadied == 1 )
	
	set CombatMage to 1
	
	elseif ( player-> GetWeaponType >= 9 )
	
	set CombatMage to 1
	
	elseif ( player-> GetWeaponType <= 8 )
	
	set CombatMage to 3
	
	endif
	
	elseif ( CombatStyle >= 3 ) ;no combat magic
	
	set CombatMage to 3
	
	elseif ( CombatStyle == 0 ) ;AI choose
	
	set CombatMage to 0
	
	endif
	
	if ( CombatMage != MageState ) ;MageState is a doonce for spell
	switching
	
	if ( MageState != 3 ) ;don't remove spells that aren't there
	
	if ( CombatMage != 0 ) ;don't remove spells just to add them back
	
	;remove unwanted spells here
	
	endif
	
	endif
	
	if ( CombatMage == 0 )
	
	;add all combat spells here
	
	elseif ( CombatMage == 1 )
	
	;add targeted spells here
	
	elseif ( CombatMage == 2 )
	
	;add touch spells here
	
	endif
	
	set MageState to CombatMage
	
	AIFollow player 0 0 0 0 ;this ensures that changes take effect
	immediately
	
	endif
\end{lstlisting}

\hypertarget{making-actors-lie-down}{%
\subsection{Making Actors lie down}\label{making-actors-lie-down}}

It's not uncommon for modders to want actors to lie down, e.g. as a
scheduled rest at night or a "corpse" that comes to life to attack the
player. Making this happen is not as simple as it sounds, so I thought
I'd present a few ideas here. \textbf{This is not a complete list of all
information}: it's just a place to start.

\textbf{Custom animations:}

These can be added to NPCs in the Construction Set (open the NPC's info
box, "Add animation file" button, and select file); to play the
animation use AIWander with 100 chance for the relevant idle and 0
chance for all other idles (assuming the animation is set to replace an
idle, but most are).

Note that custom animations replace at least one standard animation, so
you will also need to ensure that animation isn't played at random when
you don't want the actor lying down. You will also need to prevent the
player activating the NPC while the animation is playing (since the NPC
is alive and conscious, activation will give normal dialogue), and
prevent the NPC saying voice entries: this can be achieved by adding an
empty entry for each relevant voice dialogue type and filtering it
carefully. You can also add an empty greeting (carefully filtered) to
prevent the player talking to NPCs, or creatures with dialogue.

\textbf{PlayGroup:}

In theory at least, you can use knockdown or death animations to make an
actor lie down (for basic usage, see the function description). Note
that some character animation groups may not work as expected with
Bloodmoon, and some are different for different races. Note also that
the NPC's upper body may not play the correct animation; this may be
version-dependent (not tested) so even if it seems to work - be careful!
In my experience, under version 1.6.1820, PlayGroup is too unreliable to
be of much use with NPCs.

If you do use PlayGroup, you will also need to stop NPCs using normal
voices and prevent the player activating them for dialogue, as above.

\textbf{0 Fatigue:}

This is usually the easiest method to use, and you won't need to do
anything special to prevent the actor talking to the player while
unconscious/dead/asleep. Note however that it will not work reliably by
itself: usually the actor will not fall unless it takes a hit in combat
or tries to move from where it is standing. Also note that if you use
ModCurrentFatigue, the actor's Fatigue may end up set to a negative
value: if you want to revive the actor at a particular time, be sure to
mod Fatigue back up completely.

From my own tests, AIActivate is the best and most reliable method of
getting the actor to move (and therefore fall) when at 0 Fatigue. Place
the object to be activated far enough away from the actor so that the
actor will try to move, and give a different AI command when reviving
the actor. AIWander with distance (e.g. "AIWander 512 0 0") may also be
useful, but be aware that the actor may stand in place for a while
before falling (depends on the random idle/wander).

Other AI commands (including AIFollow) are not suitable: for example,
AIFollow will have the actor standing up to follow when necessary, then
falling down when the follow target stops moving. AIEscort \emph{may}
work if you can be sure the escort target will never be too far away:
once the target is far enough away that the actor would normally stop
and wait, the actor will "warp" to a standing position and stay there
until the escort target comes back within range.

If you want the NPC to stop breathing, you can wait briefly after the
AIActivate to give your NPC time to collapse, then add a paralysis
ability.\\
\emph{\textbf{Arrow- or magical traps}}

I had originally posted this as an example script for setdelete (as
which I received it from Bethesda), but I think it is better placed
here.

When this script is placed on an object, as soon as it is placed in the
world (or encountered if it was placed in the editor) it will calculate
where the player is and move towards that location at a steady rate
(determined with GetSquareRoot). When that point is reached, or if the
object is ever within range of the player, it explodes (with
ExplodeSpell) and disables. Once it has detonated, it waits a few frames
for the spell system to clear, then deletes itself (with SetDelete).

\lstinputlisting{scripts/trapProjScript.txt}

\hypertarget{scripted-teleporting}{%
\subsection{Scripted teleporting}\label{scripted-teleporting}}

Teleporting to variable positions in interior, and especially exterior
locations is not trivial, there are issues with surrounding cells not
loading properly (meaning part of the landscape may not be rendered) or
crashes. One solution was suggested by Aftershock\_81:

COE 0 0

Player-> SetPos x xpos

Player-> SetPos x ypos

Player-> SetPos x zpos

FixMe

where FixMe is meant to reload the destination cell to avoid the problem
where SetPos does not force the cell to load correctly.

I only ever managed to get Aftershock's method to work via a local
script, when I tried using a global script, everything worked, but I got
an ``Function greater than index count'' error. A good example of using
setpos and fixme can be found in Dongle's Ranger Tent mod, available on
Planet Elder Scrolls.

If you use FixMe, you may also want to use SetPos again, as fixMe will
move the player. It depends on how accurately you want to place the
player.

\hypertarget{example-script-by-nigedo-based-on-the-work-of-aftershock_81-and-jog}{%
\subparagraph{Example script, by Nigedo (based on the work of
Aftershock\_81 and
JOG)}\label{example-script-by-nigedo-based-on-the-work-of-aftershock_81-and-jog}}

Note: This script \textbf{must} be a local script. Attach it to an
activator or door: It will not work as a global script!

\lstinputlisting{scripts/script_PlacePC.txt}

If it is not possible to simply attach the script to an activate-able
item, one alternative is to have another script (global or local) place
an item in the player's inventory temporarily, with a teleport script
attached to the inventory item (thanks to Kaos\_nyrb and Nigedo).

\hypertarget{interaction-between-mods}{%
\subsection{\texorpdfstring{\hfill\break
Interaction between
mods}{ Interaction between mods}}\label{interaction-between-mods}}

\emph{(Thanks to Emma, TheOtherFelix and Ragnar\_GD for much of this
information.)}

\hypertarget{some-cautions}{%
\subparagraph{Some cautions}\label{some-cautions}}

\begin{itemize}
\item
  If you want your mod to include interaction with someone else's mod,
  the modder in question should be contacted first, and permissions
  asked.
\item
  An update to the mod you wish to interact with may destroy
  compatibility if certain things are changed (another reason to ask
  permission first!).
\item
  If the mod you wish to interact with is removed from the load list,
  this may cause problems (depending on what you want to do).
\item
  Be very careful! Always test thoroughly to make sure you haven't
  broken anything.
\end{itemize}

\hypertarget{global-variables-1}{%
\subparagraph{Global variables}\label{global-variables-1}}

Global variables are not unique to a single mod: if another mod contains
a variable of the same name, the last mod to load will overwrite the
other, and both mods can set the global from script \emph{(Note by GBG:
-- one more reason why people should try to use unique names wherever
possible in their mods -- don't name your global "check" at least call
it (your initials)\_check, e.g. "YI\_check" -- that avoids lots of
problems and compatibility issues)}.

This can be used to facilitate interaction between mods: by implementing
a global of the same type with the same default value in your own mod,
it is possible to test for the value of that global in script or
dialogue without interfering with the other mod (as long as you
\textbf{never set the global}, and make sure you give it the same
default value and type, it will have no effect on the other mod). When
the other mod sets the global to some value other than the default, this
can be detected.

Some modders have used this simply to "declare" a mod to others, by
setting a global (usually from a startscript) so that it can be detected
from script or dialogue. In other cases the interaction is more complex:
for example, since a global can be tested from dialogue, and dialogue
resultbox scripts aren't compiled until the line is "said" in game, a
global can be used as a dialogue filter for a line whose resultbox
script can only be run while the second mod is loaded (e.g. starting a
script or referencing an ID that doesn't exist in your mod). Another
common use is in "follow globals" for companions, which may be tested in
dialogue or script to detect whether an NPC from a different mod is
currently in AIFollow mode.

\hypertarget{local-variables-1}{%
\subparagraph{Local variables}\label{local-variables-1}}

Emma and TheOtherFelix introduced this ingenious idea with "emmasnpcid":
this local variable is declared and set to a unique value for each of
Emma's companions, and can then be tested for those values in dialogue.
This makes it possible to identify the companion the player is currently
in dialogue with, thus opening up a great range of possibilities.

A simpler use of local variables in dialogue is to make dialogue from
your mod \emph{unavailable} to NPCs with that local variable, in cases
where other modders might want to prevent their NPCs being affected by a
particular mod.

\hypertarget{journal-entries}{%
\subparagraph{Journal entries}\label{journal-entries}}

It is possible to test journal entries from other mods, in much the same
way as for globals. To do this, create a dummy journal topic with the
same ID as the original (leave the topic blank). You can then test the
journal index in your own mod. This does not interfere with the journal
entries added by the original mod.

\hypertarget{safely-starting-global-scripts--avoiding-the-main-script}{%
\subsection{\texorpdfstring{\hfill\break
Safely starting global scripts- avoiding the main
script}{ Safely starting global scripts- avoiding the main script}}\label{safely-starting-global-scripts--avoiding-the-main-script}}

With the expansion, this issue is a problem no more -- just add the
script you want to start running to the list of "Start Scripts" by
selecting Edit Start Scripts from the Gameplay menu. This script will
now be automatically started when a game is loaded, just like the main
script. For those without Tribunal/Bloodmoon:

Many modders like to add a line to the main script (the only script that
is started by default when a new game is started, and always runs) to
make sure a global script is started that is essential to their mod. For
example:

StartScript "My\_Script"

While this works, it might easily cause conflicts with mods that used
the same approach -- because only the changes of the last loaded plugin
will be active in the game. There are some good alternatives to using
the main script. Putting an (invisible) activator in the Seyda Neen
census office with the following attached script will make sure the
script is started during character creation (assuming no alternative
char gen mods are used alongside your mod):

\lstinputlisting{scripts/Script_launcher.txt}

To make sure a global script is started in an already running game you
can use a similar method, and place activators in commonly visited
cells. If you have one in Balmora, Vivec, Sadrith Mora, Dagon Fel, and
Caldera and maybe the PC strongholds, I am sure it won't take long until
the script is running. You can also use an object that is required for
your mod anyway to start it. E.g. for Indestructibles excellent Bank
mod, I made myself a version that attaches the above script to the
banner of the bank and starts the "interest" script. That makes sure
that that script is running before the PC ever sets foot inside the
bank.

\hypertarget{use-sound-to-detect-events}{%
\subsection{\texorpdfstring{\hfill\break
Use sound to detect
events}{ Use sound to detect events}}\label{use-sound-to-detect-events}}

This to me was a very smart idea (thanks to BalorNG), so it bears
mentioning again here, although it's also described in the sound section
above. You can use the GetSoundPlaying function to determine certain
events in the game that would otherwise not be accessible. Just take a
look at the sounds in the Gameplay/sounds menu, and it may give you some
ideas: determine if someone is falling, determine whether a certain
monster is near, determine a hit with a weapon etc.

Here is some more info on this (thanks Horatio):

\emph{GetSoundPlaying is a very powerful command that can be used to
detect when the PC ( and I'm assuming other Actors ) is doing a certain
action like casting a spell or swinging a weapon. I used it in my
spellcasting mod to determine when the PC is casting a spell and what
school of magic the spell is in. the format is as follows:\\
\strut \\
}if ( player-> GetSoundPlaying, "Sound ID" == 1 )\\
;do something cool here\\
endif\\
\emph{\hfill\break
Look in the sounds menu in the TESCS to find which Sound ID corresponds
to a specific action. For instance "illusion cast" corresponds to the
player casting an illusion based spell. You'll probably have to
experiment a little. Note: for some reason the Sound ID "drink" causes
an error, so no checking if the PC is drinking a potion.}

\hypertarget{large-battles}{%
\subsection{Large battles}\label{large-battles}}

(by Horatio)

The easiest way to do a large battle between two groups of NPCs is to
use the AI commands. Let's use an example of a bunch of imperial
legionnaires, with whom the PC is aligned, versus a dark brotherhood
gang. First set the 'fight' rating ( in the AI tab) of the DB NPCs to
100 so that they'll attack the PC on sight. Then, you'll need to set the
AI of the legionnaires to:

AIFollow player 0 0 0 0

You can do this either with scripts attached to the legion NPCs or with
an external script. The default behavior of AIFollow is to attack
whatever is attacking the person they are following. So when the DB guys
attack the PC, all the legionnaires will freak out and starting
attacking them back. Presto instant giant melee.

I use a variation on this in the GIANTS mod to convince the guards to
attack monsters that are actually NPCs ( vampires, shades, giants,
gorgos, etc ).

\hypertarget{a-guide-to-making-ridable-objects}{%
\subsection{\texorpdfstring{\hfill\break
A guide to making ridable
objects}{ A guide to making ridable objects}}\label{a-guide-to-making-ridable-objects}}

(By MadMax\_001)

MadMax shares his insights on how to make ridable objects (e.g. boats)
here, especially which problems will arise and what he did to solve
them. There is a lot of interesting info here that goes beyond just this
specific application, though. You can look at his scripts in the
"Fishing Academy" and the "Magic Carpet" Mods (but don't use them in
your mod without his consent).

\hypertarget{selecting-objects}{%
\subsubsection{\texorpdfstring{Selecting objects
}{Selecting objects }}\label{selecting-objects}}

Practically all objects (statics/activators) can be used. However,
selecting the right type of objects is paramount. It will make your
scripting a lot easier later on. Now, what type of objects are suitable?
Preference is given to small and minimum height ( thickness ). The other
important factor is the center point which is also the point where your
character will be standing on. This will also save you a lot of
programming work later on. If the object center point is not what you
want, you can fix this by importing the object to 3DS and move the axis
to the point to where you plan your character to stand. I am not going
to explain in details how to do it in 3DS, there should be quite a
number of tutorials out there which teach you how to do it.

\hypertarget{creatingdeleting-objects}{%
\subsubsection{\texorpdfstring{Creating/Deleting objects
}{Creating/Deleting objects }}\label{creatingdeleting-objects}}

I am sure a lot of modders know that you can only move an object through
the exterior cells within certain distances. This is because the game
will only update and process objects/codes within a certain

distance. When your character gets out of that parameter, the object
will actually be frozen or to the player, the object has
warped/disappeared into thin air. But, if you trace back to the original
cell, the object will re-appear.

Now, to move objects throughout the entire exterior cells, the trick to
use here is to create a new object. Everytime when you move to a new
cell, the function "CellChanged" will become TRUE for one frame. This is
the best time to replace the existing object with a new one. There is
one BIG problem that I discovered here. NEVER create an object from an
object script. It doesn't seems to work. So, what you need to do is to
use a global script to create one instead. At the same time, do not
forget to Delete the old object or you will have all these objects
spreading in different cells which will cause you major problems later
on. Always maintain one object at one time. Below is a simple example
you can use:

;-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-

; Object script

;-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-

if ( player-> CellChanged == 1 )

Startscript, "Create\_obj\_script" ; this is the global script

set obj\_count to ( obj\_count - 1 ) ; global parameter to count how
many object exist

Disable

SetDelete, 1

endif

;-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-

; Global script

;-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-

PlaceAtPC "objectname", 1, 0, 0 ; or you can use PlaceItem

set obj\_count to ( obj\_count + 1 )

Stopscript "create\_obj\_script"

Ideally, the above script should work like a charm but in reality it is
going to cause you major problems. Deleting an object immediately after
changing cell may sometimes cause CTD. This is especially true when you
have a heavy area loading. To fix this problem, delay the deletion.
Introduce a time delay ( I personally find the 1.5seconds to be OK so
far ). Here's how the object script will looks like now.

if ( player-> CellChanged == 1 )

Startscript, "Create\_obj\_script" ; this is the global script

Disable

set timer\_flag to 1

endif

if ( timer\_flag == 1 )

set timer to ( timer + GetSecondsPassed )

if ( timer > 1.5 )

set obj\_count to ( obj\_count - 1 )

SetDelete, 1

else

return ; stop all other code processing

endif

endif

That is not all. If you plan to move your object at very high speed.
There is a possibility that the object may encounter another cell change
during the 1.5 seconds delay. You must make sure that the object gets
deleted before it gets out of the processing parameter or it will come
back and haunt you later. Now the script looks like this.

if ( player-> CellChanged == 1 )

if ( timer\_flag == 1 )

SetDelete, 1

return

endif

Startscript, "Create\_obj\_script"

Disable

set timer\_flag to 1

endif

if ( timer\_flag == 1 )

set timer to ( timer + GetSecondsPassed )

if ( timer > 1.5 )

SetDelete, 1

else

return

endif

endif

\hypertarget{falling-off-from-objects}{%
\subsubsection{\texorpdfstring{Falling off from objects
}{Falling off from objects }}\label{falling-off-from-objects}}

This is actually very simple. Remove the gravitational effect on the
character. This can be achieved by either introducing a levitation or
floating ability to the character (\textbf{Note} by GBG: SetPOS also
works for this purpose). The former being the perfect solution but it
will disable your ability to make use of detecting RUN and SNEAK
buttons. The latter allows you to detect movements but at the expense of
possible falloff. You must also be wondering why your character falls
off in the first place. The fact is that everytime when you create an
object, the object collision parameter are not updated. It

will be updated though when you change cell. You will find out that you
can actually clip through the object with your character. The good news
is that there is a way to work around this. By Disable and then Enable
the object again will automatically update this. To make sure that the
object is always "SOLID", perform the Disable and Enable at least once
in every frame in the object script.

\hypertarget{collision-detection}{%
\subsubsection{\texorpdfstring{Collision detection
}{Collision detection }}\label{collision-detection}}

This is biggest headache of all. Objects will not collide with objects.
Only character/NPC/creatures can collide with objects. In this term,
objects means statics/activators and landmass. The only way to detect
collision is when your character hit the object. That is why I mentioned
earlier that if you select a big object to ride, you will see clipping
until the moment your character hit something. If you can live with
that, that's fine otherwise it looks pretty awkward. The simplest method
to detect collision is to get your player coordinates and measure
against the object coordinates ( the one you are riding on ). Although,
this is not fully proven, using GetSquareRoot function in the object
script can sometimes cause CTD. There are 2 planes that you need to take
care of. For eg, the flying carpet uses detection for both vertical (z
axis) and horizontal (x, y axis ) planes. You can refer to my script on
how this is done. If somebody can come up with a better method, please
do share it.

\hypertarget{savegame-issue}{%
\subsubsection{\texorpdfstring{Savegame issue
}{Savegame issue }}\label{savegame-issue}}

If you have not realised already, when you save your game while in
motion, the object coordinates updated in the your savegame are the ones
during the cell changed. In order to position the object correctly, it
is always best to keep a global parameters of the object coordinates.
When you first load the game, do a detection on the object existing
coordinates vs its global coordinates. If there is a big discrepancy,
set the object to the global coordinates. In this way, when you first
load the game, the object will be in precisely the same position when
you save it.

\hypertarget{trigonometry-script---fast-sine-and-cosine}{%
\subsection{\texorpdfstring{\hfill\break
Trigonometry script - fast sine and
cosine}{ Trigonometry script - fast sine and cosine}}\label{trigonometry-script---fast-sine-and-cosine}}

I asked JDGBOLT to share his latest, greatest trigonometry script with
the readers of MSFD, and I am happy to present it here. Although it is
very long, I believe this will be an invaluable resource for anyone
doing scripts involving trigonometry, e.g. those involving directional
movement. I have edited and commented the original script to make it
easy to use for any modder. Please give JDGBOLT credit if you use this!

The script calculates the sine and cosine of three angles. These will
usually be the angles of all three axes of an object, obtained with
GetAngle. Store these angles in the global variables

float Z\_input\_variable

float X\_input\_variable

float \_input\_variable

You can do this e.g. from another script on the object you are moving.
Then run the script: Startscript jdtrigscript. The script in this
version is self-terminating and will place the results in the following
global variables:

Float Z\_sin

Float Z\_cos

Float X\_sin

Float X\_cos

Float Y\_sin

Float Y\_cos

You need to create all of the global variables before you can compile
this script. The script is very fast, and the results very precise. The
results will be available after one frame.

(Extra thanks to JDGBOLT for sharing his script! By the way, this is the
colored script output from MWEdit, see the tip on alternative editors.)

\lstinputlisting{scripts/jdtrigscript.txt}

\hypertarget{mannequins}{%
\subsection{\texorpdfstring{\hfill\break
Mannequins}{ Mannequins}}\label{mannequins}}

These are popular with many people as they are a nice way to show off
your collected armor -- you find them in many house mods -- this shows
how it is done (many thanks to Stephen Kent aka Riiak Shi Nal for
sharing the script). \emph{This example is a "next generation" one that
uses Tribunal functions for checking weapon/armor to prevent PC from
moving mannequin while} weapons (Riiak has not yet figured out how to
get mannequins to wield weapons) and\emph{/or armor are present on
mannequin. Also split into two separate scripts to support both male and
female versions of the mannequin. These changes do not prevent PC from
picking up the mannequin while there are still misc items on it, those
items will be lost.}

I have added some extra comments in addition to Riiak's. The Mannequin
is in reality a normal NPC with 0 health or corpse (health set to 0 in
TES CS). For this version you simply activate it to give it items, and
it will equip armor you give it.

\lstinputlisting{scripts/rsn_mannequin_f_script.txt}

The following script goes on the item that's added to our inventory when
we move the mannequin. When you drop it, a new mannequin is created at
your feet, hence the necessary removal of armor. You will lose it all
otherwise:

; Script split into two scripts to handle the two different mannequin
genders.

% External .txt file misspelled. extra space

\lstinputlisting{scripts/rsn_man_f_holder_script .txt}

\hypertarget{cinematic-sequence}{%
\subsection{\texorpdfstring{\hfill\break
Cinematic sequence}{ Cinematic sequence}}\label{cinematic-sequence}}

The following is a very smart approach to do a cinematic sequence by
gianluca (Morrowind Summit forums). It removes player control, places
the player on an invisible "CollisionWall" object and then moves him
(and thus the camera) around. You can't have cinematic sequences
involving the PC, but it's still great.

If menumode==1\\
return\\
endif\\
\strut \\
if doOnce==0\\
"Collision wall2"-> disable\\
"Collision wall3"-> disable\\
"Collision wall4"-> disable\\
set doOnce to 1\\
endif\\
\strut \\
if doOnce==1\\
"Collision wall1"-> moveworld X 800\\
messagebox "moving"\\
if ( "Player"-> getPos Z < 570 )\\
set doOnce to 2\\
set playxx to "Player"-> getPos X\\
set playyy to "Player"-> getPos Y\\
set playzz to "Player"-> getPos Z\\
"Collision wall2"-> enable\\
"Player"-> position -114679 -4119 590 90\\
endif\\
endif\\
\strut \\
if doOnce==2\\
"Collision wall2"-> moveworld X 800\\
messagebox "moving"\\
if ( "Player"-> getPos Z < 570 )\\
set playxx to "Player"-> getPos X\\
set playyy to "Player"-> getPos Y\\
set playzz to "Player"-> getPos Z\\
"Collision wall3"-> enable\\
°Player°-> position -112634 -4119 590 90\\
set doOnce to 3\\
endif\\
endif\\
\strut \\
if doOnce==3\\
"Collision wall3"-> moveworld X 200\\
"Collision wall3"-> moveworld Y -800\\
if ( "Player"-> getPos Z < 570 )\\
set doOnce to 4\\
set playxx to "Player"-> getPos X\\
set playyy to "Player"-> getPos Y\\
set playzz to "Player"-> getPos Z\\
"Collision Wall4"-> enable\\
°Player"-> position -112126 -6150 590 90\\
endif\\
endif\\
\strut \\
if doOnce==4\\
"Collision wall4"-> moveworld X 600\\
"Collision wall4"-> moveworld Y -450\\
if ( "Player"-> getPos Z < 570 )\\
set doOnce to 5\\
set playxx to "Player"-> getPos X\\
set playyy to "Player"-> getPos Y\\
set playzz to "Player"-> getPos Z\\
endif\\
endif\\
\strut \\
if doOnce==5\\
stopscript ELDQ\_visualforbattle\\
endif\\
end ELDQ\_visualforbattle
